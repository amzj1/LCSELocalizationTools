name: Build JAR
on: [push, workflow_dispatch]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. 设置 JDK 8 (老项目标配)
      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      # 2. 关键步骤：下载 Gradle 4.10.3 并强行覆盖项目设置
      - name: Build with Gradle 4.10.3
        run: |
          cd LCSESNXUtility
          
          # 下载 Gradle 4.10.3
          wget -q https://services.gradle.org/distributions/gradle-4.10.3-bin.zip
          unzip -q gradle-4.10.3-bin.zip
          export PATH=$PWD/gradle-4.10.3/bin:$PATH
          
          # 验证版本
          gradle -v
          
          # 注入 fatJar 任务 (适配旧版 Gradle 写法)
          # 注意：旧版 Gradle 语法略有不同，这里使用最通用的写法
          echo "" >> build.gradle
          echo "task fatJar(type: Jar) {" >> build.gradle
          echo "    manifest { attributes 'Main-Class': 'charlie.lcsetools.snxutil.BatchRunnerKt' }" >> build.gradle
          echo "    from { configurations.compile.collect { it.isDirectory() ? it : zipTree(it) } }" >> build.gradle
          echo "    with jar" >> build.gradle
          echo "    classifier = 'all'" >> build.gradle
          echo "}" >> build.gradle

          # 强制使用本地下载的 Gradle 4.10.3 运行构建
          # 不使用 ./gradlew，防止它自己去下载不兼容的新版本
          gradle fatJar --no-daemon --stacktrace

      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: LCSESNXUtility-Final
          path: LCSESNXUtility/build/libs/*-all.jar
