name: Build JAR
on: [push, workflow_dispatch]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 使用 Java 11，它对旧版 Kotlin 1.3 兼容性较好
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Build with Gradle
        run: |
          cd LCSESNXUtility
          # 1. 下载兼容的 Gradle 6.9.4
          wget -q https://services.gradle.org/distributions/gradle-6.9.4-bin.zip
          unzip -q gradle-6.9.4-bin.zip
          export PATH=$PWD/gradle-6.9.4/bin:$PATH

          # 2. 自动注入 Fat JAR 任务，确保生成的程序包含所有库
          # 这样你下载后双击或 java -jar 就能直接运行
          echo "" >> build.gradle
          echo "task fatJar(type: Jar) {" >> build.gradle
          echo "    manifest { attributes 'Main-Class': 'charlie.lcsetools.snxutil.BatchRunnerKt' }" >> build.gradle
          echo "    from { configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) } }" >> build.gradle
          echo "    with jar" >> build.gradle
          echo "    archiveClassifier = 'all'" >> build.gradle
          echo "}" >> build.gradle

          # 3. 执行编译（关闭守护进程以减少错误）
          gradle fatJar --no-daemon --stacktrace

      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: LCSESNXUtility-Success
          path: LCSESNXUtility/build/libs/*-all.jar
